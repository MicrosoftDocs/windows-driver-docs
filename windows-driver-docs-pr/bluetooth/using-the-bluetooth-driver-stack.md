---
title: How to Use the Bluetooth Driver Stack
description: How to use the Bluetooth Driver Stack
keywords:
- Bluetooth WDK , driver stack
- driver stacks WDK Bluetooth
- stacks WDK Bluetooth
- Plug and Play WDK Bluetooth
- PnP WDK Bluetooth
- IRPs WDK Bluetooth
- profile drivers WDK Bluetooth
- IOCTL_INTERNAL_BTH_SUBMIT_BRB
- Bluetooth WDK , Bluetooth request blocks
- BRBs WDK
- Bluetooth request blocks WDK
- IRP_MJ_DEVICE_CONTROL
- IRP_MJ_INTERNAL_DEVICE_CONTROL
- Bluetooth WDK , IOCTLs
- IOCTLs WDK Bluetooth
- remote connections WDK Bluetooth
- connections WDK Bluetooth
ms.date: 01/10/2024
---

# How to use the Bluetooth Driver Stack

After Windows loads and initializes the Bluetooth driver stack, the driver stack discovers active Bluetooth devices that have already been paired. The driver stack then generates device identifiers (device IDs) for all paired devices. Next, the driver stack uses standard Plug and Play (PnP) mechanisms to load the appropriate profile driver for each device. The profile driver to be loaded is selected based on the INF file that installs the profile driver and the device identifier, as generated by the Bluetooth driver stack and described in [Installing a Bluetooth Device](installing-a-bluetooth-device.md).

Profile drivers communicate with the Bluetooth driver stack through the standard I/O Request Packet (IRP)-based mechanism employed by all drivers based on the WDM architecture. A profile driver communicates with its device by allocating and sending IRPs down the Bluetooth driver stack to the Bluetooth port driver, *Bthport.sys*.

A profile driver allocates and initializes IRPs to be processed by *Bthport.sys*. Profile drivers then communicate with their devices by using IOCTL requests that are delivered to the device by means of an **[IRP_MJ_INTERNAL_DEVICE_CONTROL](../kernel/irp-mj-internal-device-control.md)** or **[IRP_MJ_DEVICE_CONTROL](../kernel/irp-mj-device-control.md)** IRP. The profile driver specifies one of the I/O control codes in the following list in the IRP.

The Bluetooth driver stack supports the following IOCTLs for kernel-mode callers through **[IRP_MJ_DEVICE_CONTROL](../kernel/irp-mj-device-control.md)**:

**[IOCTL_BTH_DISCONNECT_DEVICE](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_disconnect_device)**

**[IOCTL_BTH_GET_DEVICE_INFO](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_get_device_info)**

**[IOCTL_BTH_GET_LOCAL_INFO](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_get_local_info)**

**[IOCTL_BTH_GET_RADIO_INFO](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_get_radio_info)**

**[IOCTL_BTH_SDP_ATTRIBUTE_SEARCH](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_sdp_attribute_search)**

**[IOCTL_BTH_SDP_CONNECT](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_sdp_connect)**

**[IOCTL_BTH_SDP_DISCONNECT](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_sdp_disconnect)**

**[IOCTL_BTH_SDP_REMOVE_RECORD](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_sdp_remove_record)**

**[IOCTL_BTH_SDP_SERVICE_ATTRIBUTE_SEARCH](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_sdp_service_attribute_search)**

**[IOCTL_BTH_SDP_SERVICE_SEARCH](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_sdp_service_search)**

**[IOCTL_BTH_SDP_SUBMIT_RECORD](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_sdp_submit_record)**

**[IOCTL_BTH_SDP_SUBMIT_RECORD_WITH_INFO](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_bth_sdp_submit_record_with_info)**

The Bluetooth driver stack supports the following IOCTLs and **[BRBs](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb)** kernel-mode callers (generally for driver-to-driver communication) through **[IRP_MJ_INTERNAL_DEVICE_CONTROL](../kernel/irp-mj-internal-device-control.md)**:

**[BRB_HCI_GET_LOCAL_BD_ADDR](/previous-versions/ff536611(v=vs.85))**

**[BRB_L2CA_REGISTER_SERVER](/previous-versions/ff536618(v=vs.85))**

**[BRB_L2CA_UNREGISTER_SERVER](/previous-versions/ff536619(v=vs.85))**

**[BRB_L2CA_OPEN_CHANNEL](/previous-versions/ff536615(v=vs.85))**

**[BRB_L2CA_OPEN_CHANNEL_RESPONSE](/previous-versions/ff536616(v=vs.85))**

**[BRB_L2CA_CLOSE_CHANNEL](/previous-versions/ff536614(v=vs.85))**

**[BRB_L2CA_ACL_TRANSFER](/previous-versions/ff536613(v=vs.85))**

**[BRB_L2CA_UPDATE_CHANNEL](/previous-versions/ff536620(v=vs.85))**

**[BRB_L2CA_PING](/previous-versions/ff536617(v=vs.85))**

**[BRB_REGISTER_PSM](/previous-versions/ff536621(v=vs.85))**

**[BRB_UNREGISTER_PSM](/previous-versions/ff536632(v=vs.85))**

**[BRB_SCO_REGISTER_SERVER](/previous-versions/ff536628(v=vs.85))**

**[BRB_SCO_UNREGISTER_SERVER](/previous-versions/ff536630(v=vs.85))**

**[BRB_SCO_OPEN_CHANNEL](/previous-versions/ff536626(v=vs.85))**

**[BRB_SCO_OPEN_CHANNEL_RESPONSE](/previous-versions/ff536627(v=vs.85))**

**[BRB_SCO_CLOSE_CHANNEL](/previous-versions/ff536622(v=vs.85))**

**[BRB_SCO_TRANSFER](/previous-versions/ff536629(v=vs.85))**

**[BRB_SCO_GET_CHANNEL_INFO](/previous-versions/ff536624(v=vs.85))**

**[BRB_SCO_GET_SYSTEM_INFO](/previous-versions/ff536625(v=vs.85))**

**[BRB_SCO_FLUSH_CHANNEL](/previous-versions/ff536623(v=vs.85))**

**[BRB_ACL_GET_MODE](/previous-versions/ff536609(v=vs.85))**

**[BRB_ACL_ENTER_ACTIVE_MODE](/previous-versions/ff536608(v=vs.85))**

**[BRB_GET_DEVICE_INTERFACE_STRING](/previous-versions/ff536610(v=vs.85))**

**[IOCTL_INTERNAL_BTH_SUBMIT_BRB](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_internal_bth_submit_brb)**

**[IOCTL_INTERNAL_BTHENUM_GET_DEVINFO](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_internal_bthenum_get_devinfo)**

**[IOCTL_INTERNAL_BTHENUM_GET_ENUMINFO](/windows-hardware/drivers/ddi/bthioctl/ni-bthioctl-ioctl_internal_bthenum_get_enuminfo)**

For more information about how to use the IOCTLs described in the previous lists, see [Bluetooth IOCTLs](bluetooth-ioctls2.md).

Profile drivers primarily use IOCTL_INTERNAL_BTH_SUBMIT_BRB to communicate and interact with the functionality provided in the Bluetooth driver stack. A profile driver uses IOCTL_INTERNAL_BTH_SUBMIT_BRB to deliver a variable-length data structure called a Bluetooth Request Block (**[BRB](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb)**) to the device it manages. Profile drivers use BRBs to open and close connections to remote devices and to perform most input and output tasks. IOCTL_INTERNAL_BTH_SUBMIT_BRB contains a BRB that further describes the Bluetooth operation to perform. To learn more about how to build and send BRBs down the Bluetooth driver stack, see [Building and Sending a BRB](building-and-sending-a-brb.md).

Each BRB begins with a standard header defined by the **[BRB_HEADER](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_header)** structure that specifies the type of BRB, which determines the structure of the rest of the BRB. The *Type* member, which must equal one of the values found in the **[BRB_TYPE](/windows-hardware/drivers/ddi/bthddi/ne-bthddi-_brb_type)** enumeration, determines the type of Bluetooth operation that the profile driver requests. The BRB structure and size vary according to the type of BRB. The *Length* member of the BRB_HEADER structure specifies the size, in bytes, of the BRB. The **[BthAllocateBrb](/windows-hardware/drivers/ddi/bthddi/nc-bthddi-pfnbth_allocate_brb)**, **[BthInitializeBrb](/windows-hardware/drivers/ddi/bthddi/nc-bthddi-pfnbth_initialize_brb)**, and **[BthReuseBrb](/windows-hardware/drivers/ddi/bthddi/nc-bthddi-pfnbth_reuse_brb)** functions automatically set the *Type* and *Length* members.

For example, to open a connection to a remote device, specify either one of the function codes, **BRB_L2CA_OPEN_CHANNEL** or **BRB_SCO_OPEN_CHANNEL**, to indicate that the profile driver is attempting to open a L2CAP or a SCO connection channel to the remote device. The Bluetooth driver stack uses the *Status* member of the BRB structure to return a Bluetooth-specific status code.

For each BRB, the profile driver must allocate and initialize the appropriate corresponding structure with information about the Bluetooth operation to perform.

The following table describes the structures that correspond to specific BRBs that profile drivers can issue:

| Bluetooth Request Block (BRB) | Corresponding structure |
|--|--|
| BRB_HCI_GET_LOCAL_BD_ADDR | **[_BRB_GET_LOCAL_BD_ADDR](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_get_local_bd_addr)** |
| BRB_L2CA_REGISTER_SERVER | **[_BRB_L2CA_REGISTER_SERVER](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_l2ca_register_server)** |
| BRB_L2CA_UNREGISTER_SERVER | **[_BRB_L2CA_UNREGISTER_SERVER](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_l2ca_unregister_server)** |
| BRB_L2CA_OPEN_CHANNEL | **[_BRB_L2CA_OPEN_CHANNEL](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_l2ca_open_channel)** |
| BRB_L2CA_OPEN_CHANNEL_RESPONSE | **[_BRB_L2CA_OPEN_CHANNEL](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_l2ca_open_channel)** |
| BRB_L2CA_CLOSE_CHANNEL | **[_BRB_L2CA_CLOSE_CHANNEL](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_l2ca_close_channel)** |
| BRB_L2CA_ACL_TRANSFER | **[_BRB_L2CA_ACL_TRANSFER](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_l2ca_acl_transfer)** |
| BRB_L2CA_UPDATE_CHANNEL | **[_BRB_L2CA_UPDATE_CHANNEL](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_l2ca_update_channel)** |
| BRB_L2CA_PING | **[_BRB_L2CA_PING](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_l2ca_ping)** |
| BRB_REGISTER_PSM | **[_BRB_PSM](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_psm)** |
| BRB_UNREGISTER_PSM | **[_BRB_PSM](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_psm)** |
| BRB_SCO_REGISTER_SERVER | **[_BRB_SCO_REGISTER_SERVER](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_sco_register_server)** |
| BRB_SCO_UNREGISTER_SERVER | **[_BRB_SCO_UNREGISTER_SERVER](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_sco_unregister_server)** |
| BRB_SCO_OPEN_CHANNEL | **[_BRB_SCO_OPEN_CHANNEL](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_sco_open_channel)** |
| BRB_SCO_OPEN_CHANNEL_RESPONSE | **[_BRB_SCO_OPEN_CHANNEL](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_sco_open_channel)** |
| BRB_SCO_CLOSE_CHANNEL | **[_BRB_SCO_CLOSE_CHANNEL](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_sco_close_channel)** |
| BRB_SCO_TRANSFER | **[_BRB_SCO_TRANSFER](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_sco_transfer)** |
| BRB_SCO_GET_CHANNEL_INFO | **[_BRB_SCO_GET_CHANNEL_INFO](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_sco_get_channel_info)** |
| BRB_SCO_GET_SYSTEM_INFO | **[_BRB_SCO_GET_SYSTEM_INFO](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_sco_get_system_info)** |
| BRB_SCO_FLUSH_CHANNEL | **[_BRB_SCO_FLUSH_CHANNEL](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_sco_flush_channel)** |
| BRB_ACL_GET_MODE | **[_BRB_ACL_GET_MODE](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_acl_get_mode)** |
| BRB_ACL_ENTER_ACTIVE_MODE | **[_BRB_ACL_ENTER_ACTIVE_MODE](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_acl_enter_active_mode)** |
| BRB_GET_DEVICE_INTERFACE_STRING | **[_BRB_GET_DEVICE_INTERFACE_STRING](/windows-hardware/drivers/ddi/bthddi/ns-bthddi-_brb_get_device_interface_string)** |

For more information about using Bluetooth IOCTLs and BRBs, see [Building and Sending a BRB](building-and-sending-a-brb.md).
