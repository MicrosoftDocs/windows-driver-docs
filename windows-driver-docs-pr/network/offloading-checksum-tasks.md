---
title: Offloading Checksum Tasks
description: Offloading Checksum Tasks
keywords:
- task offload WDK TCP/IP transport , checksum tasks
- checksum tasks WDK networking
ms.date: 09/19/2018
---

# Offloading Checksum Tasks

NDIS supports offloading TCP/IP checksum tasks at run time.

> [!NOTE]
>Â Checksum offload out-of-band (OOB) data is stored in the [**NET\_BUFFER\_LIST**](/windows-hardware/drivers/ddi/nbl/ns-nbl-net_buffer_list) information array. For more information about OOB data, see [Accessing TCP/IP Offload NET\_BUFFER\_LIST Information](accessing-tcp-ip-offload-net-buffer-list-information.md).

Before passing to the miniport driver a NET\_BUFFER\_LIST structure for a packet on which the miniport driver will perform checksum tasks, the TCP/IP transport specifies the checksum information that is associated with the NET\_BUFFER\_LIST structure. This information is specified by an [**NDIS\_TCP\_IP\_CHECKSUM\_NET\_BUFFER\_LIST\_INFO**](/windows-hardware/drivers/ddi/nblchecksum/ns-nblchecksum-ndis_tcp_ip_checksum_net_buffer_list_info) structure, which is part of the NET\_BUFFER\_LIST information (out-of-band data) that is associated with the NET\_BUFFER\_LIST structure.

Before offloading the checksum calculation for a TCP packet, the TCP/IP transport calculates the one's complement sum for the TCP pseudoheader. The TCP/IP transport calculates the one's complement sum across all fields in the pseudoheader, including Source IP Address, Destination IP Address, Protocol, and the TCP length for TCP packets. The TCP/IP transport enters the one's complement sum for the pseudoheader in the Checksum field of the TCP header.

The one's complement sum for the pseudoheader provided by the TCP/IP transport gives the NIC an early start in calculating the real TCP checksum for the send packet. To calculate the actual TCP checksum, the NIC calculates the variable part of the TCP checksum (for the TCP header and payload), adds this checksum to the one's complement sum for the pseudoheader calculated by the TCP/IP transport, and calculates the 16-bit one's complement for the checksum. For more information about calculating such checksums, see RFC 793 and RFC 1122.

> [!NOTE]
> The TCP/IP transport computes the one's complement sum for the pseudoheader of a UDP packet using the same steps as it does for a TCP packet, and stores the value in the Checksum field of the UDP header.

Note that the TCP/IP transport always ensures that the checksum field in the IP header of a packet is set to zero before passing the packet to an underlying miniport driver. The miniport driver should ignore the checksum field in an IP header. The miniport driver does not need to verify that the checksum field is set to zero and does not need to set this field to zero.

After it receives the NET\_BUFFER\_LIST structure in its [*MiniportSendNetBufferLists*](/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_send_net_buffer_lists) or [**MiniportCoSendNetBufferLists**](/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_co_send_net_buffer_lists) function, a miniport driver typically does the following checksum processing:

1.  The miniport driver calls the [**NET\_BUFFER\_LIST\_INFO**](/windows-hardware/drivers/ddi/nblaccessors/nf-nblaccessors-net_buffer_list_info) macro with an *\_Id* of **TcpIpChecksumNetBufferListInfo** to obtain an [**NDIS\_TCP\_IP\_CHECKSUM\_NET\_BUFFER\_LIST\_INFO**](/windows-hardware/drivers/ddi/nblchecksum/ns-nblchecksum-ndis_tcp_ip_checksum_net_buffer_list_info) structure.

2.  The miniport driver tests the **IsIPv4** and **IsIPv6** flags in the NDIS\_TCP\_IP\_CHECKSUM\_NET\_BUFFER\_LIST\_INFO structure. If both the **IsIPv4** and **IsIPv6** flags are not set, the NIC should not perform any checksum operations on the packet.

3.  If the **IsIPv4** or **IsIPv6** flag is set, the miniport driver tests the **TcpChecksum**, **UdpChecksum**, and **IpHeaderChecksum** flags to determine which checksums the NIC should calculate for the packet.

4.  The miniport driver passes the packet to the NIC, which calculates the appropriate checksums for the packet. If a packet has both a tunnel IP header and a transport IP header, a NIC that supports IP checksum offloads performs IP checksum tasks only on the tunnel header. The TCP/IP transport performs IP checksum tasks on the transport IP header.

Before indicating a [**NET\_BUFFER\_LIST**](/windows-hardware/drivers/ddi/nbl/ns-nbl-net_buffer_list) structure for a receive packet on which it performs checksum tasks, the miniport driver validates the appropriate checksums and sets the appropriate *Xxx***ChecksumFailed** or *Xxx***ChecksumSucceeded** flags in the NDIS\_TCP\_IP\_CHECKSUM\_NET\_BUFFER\_LIST\_INFO structure.

Turning off Address Checksum Offloads when Large Send Offload (LSO) is enabled does not prevent the miniport driver from computing and inserting checksums in the packets generated by the LSO feature. To disable Address Checksum Offloads in this case the user must also disable LSO.

 

